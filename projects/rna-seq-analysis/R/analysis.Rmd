---
title: "Transcriptional Analysis of RmpA-Mediated Regulation in Bacteria"
author: "Vigneshwaran Muthuraman"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: united
---

## Introduction
This analysis explores transcriptional changes in E. coli following RmpA overexpression, focusing on:

- Differential gene expression
- Pathway analysis
- Connection to RmpA function

## Setup and Data Loading
```{r setup, message=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
# Load required libraries
library(DESeq2)
library(tidyverse)
library(pheatmap)
library(EnhancedVolcano)
library(pathview)
library(KEGGREST)
library(enrichplot)
library(clusterProfiler)  
library(org.EcK12.eg.db)

# Set working directory
setwd("C:/Users/kakar/bioinformatics-portfolio/projects/rna-seq-analysis")

# Load preprocessed data
dds_filtered <- readRDS("data/processed/dds_filtered_object.rds")
normalized_counts <- readRDS("data/processed/normalized_counts.rds")
```

## Differential Expression Analysis
```{r DE-analysis, message=FALSE, warning=FALSE}
# Run DESeq analysis
dds_filtered <- DESeq(dds_filtered)

# Get results
res <- results(dds_filtered, 
              contrast=c("condition", "rmpA_overexpression", "control"),
              alpha=0.05)

# Summary of results
summary(res)

# Create results dataframe
res_df <- as.data.frame(res)
res_df$gene_id <- rownames(res_df)
```

## Results Visualization
```{r visualization, fig.width=12, fig.height=10}
# Create volcano plot
EnhancedVolcano(res_df,
    lab = res_df$gene_id,
    x = 'log2FoldChange',
    y = 'padj',
    title = 'RmpA Overexpression vs Control',
    pCutoff = 0.05,
    FCcutoff = 1,
    pointSize = 3.0,
    labSize = 4.0)

# Get top DE genes
sig_genes <- res_df[which(res_df$padj < 0.05 & abs(res_df$log2FoldChange) > 1),]
top_up <- head(sig_genes[order(-sig_genes$log2FoldChange),], 10)
top_down <- head(sig_genes[order(sig_genes$log2FoldChange),], 10)
```

## Heatmap of Top Genes
```{r heatmap, fig.width=10, fig.height=8}
# Create heatmap of top genes
top_20_genes <- rbind(top_up, top_down)
heat_counts <- normalized_counts[rownames(normalized_counts) %in% rownames(top_20_genes),]

pheatmap(heat_counts,
         scale = "row",
         show_rownames = TRUE,
         cluster_cols = TRUE,
         main = "Top 20 Differentially Expressed Genes",
         annotation_col = data.frame(
             Condition = factor(c(rep("Control", 3), rep("RmpA", 3))),
             row.names = colnames(heat_counts)
         ))
```

## Pathway Analysis

```{r pathway, fig.height=8, fig.width=12, message=FALSE, warning=FALSE}
# 1. Prepare gene list for pathway analysis
sig_genes <- subset(res, padj < 0.05 & abs(log2FoldChange) > 1)
gene_list_lfc <- sig_genes$log2FoldChange
names(gene_list_lfc) <- rownames(sig_genes)

# 2. Gene ID Conversion: ENSEMBL to ENTREZID for KEGG
# Assuming the gene IDs are ENSEMBL-like (e.g., ENSG...) or similar.
# If the IDs are already different, adjust the "keyType" accordingly.
# If your IDs are b-numbers (e.g., b0001), you might skip this and directly use 'KEGG' as keyType in enrichKEGG/gseKEGG.

gene_list_entrez <- names(gene_list_lfc)


# 3. KEGG Over-Representation Analysis (ORA)
kegg_enrich <- enrichKEGG(
  gene          = gene_list_entrez, # Use the ENTREZ IDs (or b-numbers if id conversion was not done)
  organism      = 'eco',      # organism code for E. coli
  keyType       = 'kegg',     # if gene_list_entrez is b-numbers, use 'kegg', otherwise 'ncbi-geneid' if converted to entrez
  pvalueCutoff  = 0.05,
  pAdjustMethod = 'BH',
  qvalueCutoff  = 0.10
)

if(!is.null(kegg_enrich)){ # Proceed only if enrichment results are not NULL
  if(nrow(kegg_enrich@result) > 0) { # Proceed only if enriched pathways are found
    message("KEGG Over-Representation Analysis (ORA) completed.")

    # Visualization - Dotplot for ORA (moved print() inside conditional)
    if(nrow(kegg_enrich@result) > 0) {
        print(dotplot(kegg_enrich, showCategory=20) + ggtitle("KEGG Pathway Enrichment (ORA)"))
    }


    # Save enrichment results to CSV
    write.csv(kegg_enrich@result, "kegg_ora_results.csv")

    # 4. Gene Set Enrichment Analysis (GSEA) 
    gsea_res <- gseKEGG(
      geneList    = sort(gene_list_lfc, decreasing = TRUE), # **SORT gene_list_lfc HERE**
      organism    = 'eco',
      keyType     = 'kegg', # or 'ncbi-geneid' if you converted to entrez
      pvalueCutoff = 0.05,
      pAdjustMethod = 'BH'
    )

    if(!is.null(gsea_res)){ # Proceed only if GSEA results are not NULL
      if(nrow(gsea_res@result) > 0) { # Proceed only if enriched pathways are found
        message("KEGG Gene Set Enrichment Analysis (GSEA) completed.")

        # Visualization - Ridgeplot for GSEA
        print(ridgeplot(gsea_res, showCategory=10) + ggtitle("KEGG Pathway Enrichment (GSEA)"))
        # Visualization - GSEA Plot for specific pathway (e.g., the top one)
        if(nrow(gsea_res@result) > 0){
          top_pathway_gsea <- gsea_res@result$ID[1] # Take the top pathway ID
          print(gseaplot2(gsea_res, geneSetID = top_pathway_gsea, title = gsea_res@result$Description[1]))
        }

        # Save GSEA results to CSV
        write.csv(gsea_res@result, "kegg_gsea_results.csv")
      } else {
        message("No significant pathways found in KEGG GSEA.")
      }
    } else {
      message("KEGG GSEA analysis returned NULL. Check for errors.")
    }


    # 5. Pathview Visualization for specific pathways - Focusing on significantly enriched ones
    if(!is.null(kegg_enrich) && nrow(kegg_enrich@result) > 0){
      enriched_pathways <- head(kegg_enrich@result$ID, 3) # Visualize top 3 enriched pathways from ORA
      message(paste("Generating Pathview plots for top pathways:", paste(enriched_pathways, collapse=", ")))
       for (path_id in enriched_pathways) {
          try({ # Use try() to handle potential pathview errors gracefully
            invisible(pathview(
              gene.data  = gene_list_lfc,
              pathway.id = path_id,
              species    = "eco",
              gene.idtype= "KEGG", # Ensure gene.idtype is "KEGG" if using b-numbers
              limit      = list(gene=2, cpd=1), # Adjust limit for better visualization
              low        = "blue",
              high       = "red",
              kegg.native = TRUE
            ))
          }, silent = TRUE) # silent = TRUE to suppress error messages within loop
        }
    } else {
      message("No enriched pathways from ORA to visualize with Pathview.")
    }


  } else {
    message("No significantly enriched KEGG pathways found with ORA.")
  }
} else {
  message("KEGG ORA analysis returned NULL. Check for errors.")
}

```
## Key Findings

1. Differential Expression:
   - Total genes analyzed: `r nrow(dds_filtered)` (after filtering)
   - Significantly up-regulated: `r sum(res$padj < 0.05 & res$log2FoldChange > 1, na.rm = TRUE)` genes (`r round(sum(res$padj < 0.05 & res$log2FoldChange > 1, na.rm = TRUE) / nrow(res) * 100, 0)`%)
   - Significantly down-regulated: `r sum(res$padj < 0.05 & res$log2FoldChange < -1, na.rm = TRUE)` genes (`r round(sum(res$padj < 0.05 & res$log2FoldChange < -1, na.rm = TRUE) / nrow(res) * 100, 0)`%)

2. Top Up-regulated Genes:
```{r top-up-table, echo=FALSE}
knitr::kable(top_up[, c("gene_id", "log2FoldChange", "padj")], caption = "Top 10 Up-regulated Genes")

knitr::kable(top_down[, c("gene_id", "log2FoldChange", "padj")], caption = "Top 10 Down-regulated Genes")
```

Pathway Analysis:

KEGG Over-Representation Analysis (ORA): (Summary of enriched pathways from kegg_enrich if significant results are found)

```{r echo=FALSE}
if(!is.null(kegg_enrich) && nrow(kegg_enrich@result) > 0){
  top_ora_paths <- head(kegg_enrich@result[order(kegg_enrich@result$p.adjust),], 5)
  if(nrow(top_ora_paths) > 0){
    cat("Top 5 Enriched Pathways (ORA):\n")
    knitr::kable(top_ora_paths[, c("Description", "p.adjust", "qvalue")], row.names = FALSE)
  } else {
    cat("No significantly enriched pathways found in ORA with current settings.\n")
  }
} else {
  cat("KEGG ORA analysis did not produce results.\n")
}

```

KEGG Gene Set Enrichment Analysis (GSEA): (Summary of enriched pathways from gsea_res if significant results are found)

```{r}
if(!is.null(gsea_res) && nrow(gsea_res@result) > 0){
  top_gsea_paths <- head(gsea_res@result[order(gsea_res@result$p.adjust),], 5)
  if(nrow(top_gsea_paths) > 0){
    cat("Top 5 Enriched Pathways (GSEA):\n")
    knitr::kable(top_gsea_paths[, c("Description", "p.adjust")], row.names = FALSE)
  } else {
    cat("No significantly enriched pathways found in GSEA with current settings.\n")
  }
} else {
  cat("KEGG GSEA analysis did not produce results.\n")
}
```

Biofilm-related genes (Example Markers):

```{r}
biofilm_markers <- c("b2055",  "b1024",  "b2133")
marker_gene_data <- sig_genes[rownames(sig_genes) %in% biofilm_markers, ]
if(nrow(marker_gene_data) > 0){
  cat("Expression of Biofilm Marker Genes:\n")
  knitr::kable(marker_gene_data[, c("gene_id", "log2FoldChange", "padj")], row.names = TRUE)
} else {
  cat("Biofilm marker genes are not significantly differentially expressed with current cutoffs.\n")
}
```

2. Interpretation: 

Ribosome Pathway (eco03010):

The most significantly enriched KEGG pathway in the ORA and GSEA analyses was the Ribosome pathway (eco03010). Pathview visualization shows a strong up-regulation of multiple ribosomal protein genes (e.g., rplJ, rplK, rpsC, rpsL). This suggests that RmpA overexpression leads to a significant increase in the expression of genes involved in ribosome biogenesis and protein synthesis.

This up-regulation of ribosome-related genes may indicate a global increase in protein synthesis in response to RmpA overexpression, potentially to support increased metabolic demands or the production of proteins required for RmpA-mediated functions, such as biofilm formation.

Biosynthesis of various nucleotide sugars (eco00541):

KEGG pathway enrichment analysis also revealed significant enrichment of the 'Biosynthesis of various nucleotide sugars' pathway (eco00541). Pathview plots indicate changes in genes like rfbB, rfbA, ugd within this pathway. Nucleotide sugars are precursors for exopolysaccharides (EPS), a major component of bacterial biofilms. These results suggest that RmpA may play a role in regulating biofilm formation by influencing EPS biosynthesis.

Further investigation of the specific genes up- or down-regulated in this pathway (e.g., ugd, rfbB) could reveal the precise mechanisms by which RmpA affects EPS production.

Glyoxylate and dicarboxylate metabolism (eco00630) & Fatty acid degradation (eco00071) / metabolism (eco01212):

Down-regulation of genes was observed in pathways related to carbon and fatty acid metabolism, such as 'Glyoxylate and dicarboxylate metabolism' (eco00630) and 'Fatty acid degradation' (eco00071), as visualized by pathview plots. This suggests that RmpA overexpression may be associated with a shift in cellular metabolism, potentially away from fatty acid catabolism and towards other metabolic pathways.

The down-regulation of fatty acid degradation genes could indicate a metabolic adaptation to RmpA overexpression, possibly to conserve resources or redirect metabolic flux to support other cellular processes.
